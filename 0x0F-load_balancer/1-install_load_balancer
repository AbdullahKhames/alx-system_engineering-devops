if [ -e "$haproxy_cfg" ]; then
    if grep -q "frontend techi-frontend" "$haproxy_cfg" && grep -q "backend techi-backend" "$haproxy_cfg"; then
        # Update the frontend and backend sections
sudo sed -i '/backend techi-backend/, /balance roundrobin/{/backend techi-backend/!d}' "$haproxy_cfg"
sudo sed -i 's/backend techi-backend/backend techi-backend\
        server web-01 54.174.3.157:80 check\
        server web-02 54.242.203.162:80 check\
        balance roundrobin/' "$haproxy_cfg"
sudo sed -i '/frontend techi-frontend/, /balance roundrobin/{/frontend techi-frontend/!d}' "$haproxy_cfg"
sudo sed -i 's/frontend techi-frontend/frontend techi-frontend\
        bind 0.0.0.0:8080\
        mode http\
        default_backend techi-backend/' "$haproxy_cfg"
    else
echo "frontend techi-frontend
        bind *:8080
        mode http
        default_backend techi-backend
backend techi-backend
        balance roundrobin
        server web-01 54.174.3.157:80 check
        server web-02 54.242.203.162:80 check" | sudo tee -a "$haproxy_cfg"
    fi
fi

# Check if the ENABLED=1 line exists in the default file
default_file="/etc/default/haproxy"
if [ -e "$default_file" ]; then
    if ! grep -q "ENABLED=1" "$default_file"; then
        # Append the ENABLED=1 line to the default file
        echo "ENABLED=1" | sudo tee -a "$default_file"
    fi
fi
sudo service haproxy restart
#!/usr/bin/env bash
# Create a script to install and configure HAProxy on lb-01 server
# Configure HAProxy to send traffic to web-01 and web-02 servers
# Distribute requests using a roundrobin algorithm
# Make sure that HAProxy can be managed via an init script

# Install and configure HAproxy on my lb-01 server.
sudo apt-get -y update
apt-get -y install haproxy

# edit config file
server_config=\
"
frontend techi-frontend
        bind *:8080
        mode http
        default_backend techi-backend
backend techi-backend
        balance roundrobin
        server web-01 54.174.3.157:80 check
        server web-02 54.242.203.162:80 check
"
echo "$server_config" | sudo tee -a /etc/haproxy/haproxy.cfg

# enable haproxy to be started by init script
echo "ENABLED=1" | sudo tee -a /etc/default/haproxy

# Testing the HAproxy configuration file
sudo haproxy -c -f /etc/haproxy/haproxy.cfg

# Restart the Nginx service
sudo service haproxy restart
